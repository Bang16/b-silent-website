<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - B'Silent</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .checkout-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .checkout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .checkout-grid {
                grid-template-columns: 1fr;
            }
        }

        .order-summary {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .order-total {
            border-top: 2px solid var(--brand-dark);
            padding-top: 1rem;
            margin-top: 1rem;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .checkout-header {
            text-align: center;
            padding: 1.5rem 0;
            background: var(--brand-light);
        }
    </style>
</head>
<body>
    <!-- Simplified Header -->
    <header class="checkout-header">
        <div class="container">
            <a href="index.html">
                <img src="images/logo.png" alt="PS B'Silent" style="height: 50px;">
            </a>
            <div style="margin-top: 1rem;">
                <a href="flowers.html" class="btn btn-outline">
                    ← Continue Shopping
                </a>
            </div>
        </div>
    </header>

    <main class="section">
        <div class="checkout-container">
            <h1 class="text-center">Checkout</h1>

            <div class="checkout-grid">
                <!-- Customer Information Form -->
                <div>
                    <div class="card">
                        <div class="card-body">
                            <h2>Customer Information</h2>
                            <form id="customerForm">
                                <div class="form-group">
                                    <label class="label">Full Name *</label>
                                    <input class="input" type="text" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label class="label">Email *</label>
                                    <input class="input" type="email" name="email" required>
                                </div>
                                <div class="form-group">
                                    <label class="label">Phone *</label>
                                    <input class="input" type="tel" name="phone" required>
                                </div>

                                <!-- Delivery Area Selection -->
                                <div class="form-group">
                                    <label class="label">Delivery Option *</label>
                                    <select class="input" name="delivery_area" id="deliveryArea" required onchange="updateDeliveryFee()">
                                        <option value="">Select Option</option>
                                        <option value="johannesburg">Johannesburg Delivery (R250)</option>
                                        <option value="pretoria">Pretoria Delivery (R280)</option>
                                        <option value="northwest">North West Delivery (R300)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="label">Delivery Address *</label>
                                    <textarea class="textarea" name="address" id="deliveryAddress" rows="3" required placeholder="Street address, suburb, and city"></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="label">Delivery Date *</label>
                                    <input class="input" type="date" name="delivery_date" id="deliveryDate" required>
                                </div>

                                <div class="form-group">
                                    <label class="label">Special Instructions</label>
                                    <textarea class="textarea" name="instructions" id="deliveryInstructions" rows="2" placeholder="Any special delivery instructions"></textarea>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Order Summary & Payment -->
                <div>
                    <div class="order-summary">
                        <h2>Order Summary</h2>
                        <div id="orderItems">
                            <!-- Cart items will be displayed here -->
                        </div>

                        <div class="order-item">
                            <span>Subtotal:</span>
                            <span id="subtotal">R0.00</span>
                        </div>

                        <div class="order-item">
                            <span>Delivery Fee:</span>
                            <span id="deliveryFee">R0.00</span>
                        </div>

                        <div class="order-item order-total">
                            <span>Total Amount:</span>
                            <span id="orderTotal">R0.00</span>
                        </div>

                        <!-- PayFast Payment Form -->
                        <form action="https://www.payfast.co.za/eng/process" method="post" style="margin-top: 2rem;" id="payfastForm">
                            <input type="hidden" name="merchant_id" value="30520771">
                            <input type="hidden" name="merchant_key" value="edx939hu9sglg">
                            <input type="hidden" name="return_url" value="https://bsilentofficial.co.za/order-success.html">
                            <input type="hidden" name="cancel_url" value="https://bsilentofficial.co.za/checkout.html">

                            <!-- Dynamic amounts -->
                            <input type="hidden" name="amount" id="payfastAmount" value="0.00">
                            <input type="hidden" name="item_name" id="payfastItemName" value="Flower Arrangement Order">

                            <!-- Customer details for PayFast -->
                            <input type="hidden" name="name_first" id="customerFirstName">
                            <input type="hidden" name="name_last" id="customerLastName">
                            <input type="hidden" name="email_address" id="customerEmail">
                            <input type="hidden" name="cell_number" id="customerPhone">

                            <!-- Delivery details as custom fields -->
                            <input type="hidden" name="custom_str1" id="deliveryAddressField">
                            <input type="hidden" name="custom_str2" id="deliveryDateField">
                            <input type="hidden" name="custom_str3" id="deliveryInstructionsField">

                            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                                💳 Pay Securely with PayFast
                            </button>
                        </form>

                        <p class="muted" style="text-align: center; margin-top: 1rem; font-size: 0.9rem;">
                            <i class="fas fa-lock"></i> Your payment is secure and encrypted
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Delivery fee calculation
        function calculateDeliveryFee(area) {
            const fees = {
                'johannesburg': 250,
                'pretoria': 280,
                'northwest': 300,
                'other': 350,
                'pickup': 0
            };
            return fees[area] || 0;
        }

        // Safe number conversion
        function toNumber(value) {
            if (value === null || value === undefined) return 0;
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                const num = parseFloat(value.replace(/[^0-9.]/g, ''));
                return isNaN(num) ? 0 : num;
            }
            return 0;
        }

        // Update delivery fee and total
        function updateDeliveryFee() {
            const area = document.getElementById('deliveryArea').value;
            const deliveryFee = calculateDeliveryFee(area);
            const cart = JSON.parse(localStorage.getItem('cart')) || [];

            // Calculate cart subtotal SAFELY with quantity fix
            let subtotal = 0;
            cart.forEach(item => {
                const price = toNumber(item.price);
                const quantity = item.quantity !== undefined ? toNumber(item.quantity) : 1;
                subtotal += price * quantity;
            });

            // Update displays
            document.getElementById('subtotal').textContent = `R${subtotal.toFixed(2)}`;
            document.getElementById('deliveryFee').textContent = `R${deliveryFee.toFixed(2)}`;
            document.getElementById('orderTotal').textContent = `R${(subtotal + deliveryFee).toFixed(2)}`;

            // Update PayFast amount
            document.getElementById('payfastAmount').value = (subtotal + deliveryFee).toFixed(2);
        }

        // Load cart items and calculate totals
        function loadOrderSummary() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const orderItems = document.getElementById('orderItems');
            let subtotal = 0;

            orderItems.innerHTML = '';

            if (cart.length === 0) {
                orderItems.innerHTML = '<p class="muted">Your cart is empty</p>';
                document.getElementById('subtotal').textContent = 'R0.00';
                document.getElementById('deliveryFee').textContent = 'R0.00';
                document.getElementById('orderTotal').textContent = 'R0.00';
                document.getElementById('payfastAmount').value = '0.00';
                return;
            }

            cart.forEach(item => {
                const price = toNumber(item.price);
                const quantity = item.quantity !== undefined ? toNumber(item.quantity) : 1;
                const itemTotal = price * quantity;
                subtotal += itemTotal;

                orderItems.innerHTML += `
                    <div class="order-item">
                        <span>${item.name} ${quantity > 1 ? 'x' + quantity : ''}</span>
                        <span>R${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            });

            // Update totals
            updateDeliveryFee();

            // Update PayFast item name
            if (cart.length > 0) {
                const itemNames = cart.map(item => item.name).join(', ');
                document.getElementById('payfastItemName').value = itemNames.substring(0, 100);
            }
        }

        // Set up form validation and data preparation
        document.getElementById('payfastForm').addEventListener('submit', function (e) {
            const customerForm = document.getElementById('customerForm');
            if (!customerForm.checkValidity()) {
                e.preventDefault();
                alert('Please fill in all required customer information');
                return;
            }

            // Check if cart is empty
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) {
                e.preventDefault();
                alert('Your cart is empty. Please add items before checkout.');
                return;
            }

            // Update PayFast customer details
            const name = document.querySelector('input[name="name"]').value;
            const names = name.split(' ');
            document.getElementById('customerFirstName').value = names[0] || '';
            document.getElementById('customerLastName').value = names.slice(1).join(' ') || '';
            document.getElementById('customerEmail').value = document.querySelector('input[name="email"]').value;
            document.getElementById('customerPhone').value = document.querySelector('input[name="phone"]').value;

            // Update delivery details to custom fields
            document.getElementById('deliveryAddressField').value = document.getElementById('deliveryAddress').value;
            document.getElementById('deliveryDateField').value = document.getElementById('deliveryDate').value;
            document.getElementById('deliveryInstructionsField').value = document.getElementById('deliveryInstructions').value;
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadOrderSummary();

            // Set minimum date for delivery to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryDate').min = today;

            // Set default delivery area if not set
            const deliveryArea = document.getElementById('deliveryArea');
            if (deliveryArea && !deliveryArea.value) {
                deliveryArea.value = 'johannesburg';
                updateDeliveryFee();
            }
        });

    </script>
</body>
</html>